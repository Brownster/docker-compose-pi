version: "3.8"
services:
  vpn:
    image: qmcgaw/gluetun:latest
    container_name: vpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - $DOCKER_DIR/gluetun:/gluetun
    env_file:
      - $DOCKER_DIR/gluetun/.env
    healthcheck:
      test: curl --fail http://localhost:8000 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    ports:
      - $JACKET_PORT:$JACKET_PORT  # Jackett
      - $SONARR_PORT:$SONARR_PORT   # Sonarr
      - $RADARR_PORT:$RADARR_PORT  # Radarr
      - $TRANSMISSION_PORT:$TRANSMISSION_PORT   # Transmission
      - $NZBGET:$NZBGET   # NZBGet
    networks:
      - vpn_network

  jackett:
    image: linuxserver/jackett:latest
    container_name: jackett
    network_mode: "service:vpn"
    environment:
      - TZ=$TIMEZONE
      - PUID=1000
      - PGID=1000
    volumes:
      - $DOCKER_DIR/jackett:/config
      - $DOWNLOADS:/downloads
    restart: unless-stopped

  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:vpn"
    environment:
      - TZ=$TIMEZONE
      - PUID=1000
      - PGID=1000
    volumes:
      - $DOCKER_DIR/sonarr:/config
      - $STORAGE_MOUNT/$TVSHOWS_FOLDER:/tv
      - $DOWNLOADS:/downloads
    restart: unless-stopped

  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:vpn"
    environment:
      - TZ=$TIMEZONE
      - PUID=1000
      - PGID=1000
    volumes:
      - $DOCKER_DIR/radarr:/config
      - $STORAGE_MOUNT/$MOVIES_FOLDER:/movies
      - $DOWNLOADS:/downloads
    restart: unless-stopped

  transmission:
    image: linuxserver/transmission:latest
    container_name: transmission
    network_mode: "service:vpn"
    environment:
      - TZ=$TIMEZONE
      - PUID=1000
      - PGID=1000
    volumes:
      - $DOCKER_DIR/transmission:/config
      - $DOWNLOADS:/downloads
    restart: unless-stopped

  nzbget:
    image: linuxserver/nzbget:latest
    container_name: nzbget
    network_mode: "service:vpn"
    environment:
      - TZ=$TIMEZONE
      - PUID=1000
      - PGID=1000
    volumes:
      - $DOCKER_DIR/nzbget:/config
      - $DOWNLOADS/incomplete:/incomplete
      - $DOWNLOADS/complete:/complete
    restart: unless-stopped

  jellyfin:
    image: linuxserver/jellyfin:latest
    container_name: jellyfin
    network_mode: bridge
    environment:
      - TZ=$TIMEZONE
      - PUID=1000
      - PGID=1000
    volumes:
      - $DOCKER_DIR/jellyfin:/config
      - $STORAGE_MOUNT:/media
    ports:
      - 8096:8096
      - 8920:8920
    restart: unless-stopped
    networks:
      - default

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE="0 3 * * *" # Run daily at 3 AM
    restart: unless-stopped
    networks:
      - default

networks:
  vpn_network:
    driver: bridge
  default:
    driver: bridge
